FROM python:3.11-slim

WORKDIR /app

# Install system dependencies for OpenCV and other ML libraries
RUN apt-get update && apt-get install -y \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    libgl1 \
    git \
    gcc \
    g++ \
    libgfortran5 \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies first (for better caching)
# Match local working environment versions
RUN pip install --no-cache-dir \
    torch==2.8.0 \
    torchvision==0.23.0 \
    --index-url https://download.pytorch.org/whl/cpu

# Install other dependencies from PyPI
RUN pip install --no-cache-dir \
    easyocr \
    supervision==0.18.0 \
    openai==1.3.5 \
    transformers==4.49.0 \
    ultralytics==8.3.70 \
    numpy==1.26.4 \
    opencv-python-headless \
    fastapi \
    uvicorn \
    pydantic \
    accelerate \
    timm \
    einops==0.8.0

# Install paddleocr separately (requires specific dependencies)
RUN pip install --no-cache-dir paddlepaddle paddleocr

# Pre-download PaddleOCR models to avoid startup delays
RUN python -c "from paddleocr import PaddleOCR; ocr = PaddleOCR(lang='en', use_angle_cls=False)"

# Copy OmniParser source code and weights
COPY omniparser /app/omniparser

# Expose port 8003
EXPOSE 8003

# Set working directory to omniparserserver
WORKDIR /app/omniparser/omnitool/omniparserserver

# Run OmniParser server
# Use PORT environment variable from Cloud Run (defaults to 8003)
CMD python omniparserserver.py \
    --som_model_path ../../weights/icon_detect/model.pt \
    --caption_model_name florence2 \
    --caption_model_path ../../weights/icon_caption_florence \
    --device cpu \
    --BOX_TRESHOLD 0.05 \
    --host 0.0.0.0 \
    --port ${PORT:-8003}
