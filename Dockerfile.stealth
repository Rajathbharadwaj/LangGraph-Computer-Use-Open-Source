FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:98

# Install all necessary packages including Node.js for Playwright
RUN apt-get update && apt-get install -y \
    xvfb \
    x11vnc \
    xfce4 \
    xfce4-terminal \
    python3 \
    python3-pip \
    xdotool \
    scrot \
    wmctrl \
    wget \
    xz-utils \
    xsel \
    xclip \
    curl \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# Install Python packages including Playwright
RUN pip3 install fastapi uvicorn pydantic \
    playwright playwright-stealth \
    anthropic python-dotenv aiohttp \
    requests pillow asyncio cryptography

# Install Playwright browsers and dependencies
RUN python3 -m playwright install chromium
RUN python3 -m playwright install-deps chromium

# Download and install Firefox (keep for compatibility)
RUN cd /tmp && \
    wget -q -O firefox.tar.xz "https://download.mozilla.org/?product=firefox-latest-ssl&os=linux64&lang=en-US" && \
    tar -xJf firefox.tar.xz && \
    mv firefox /opt/firefox && \
    ln -sf /opt/firefox/firefox /usr/local/bin/firefox && \
    rm firefox.tar.xz

# Create app directory
RUN mkdir -p /app

# Copy all necessary files
COPY cua_server.py /app/
COPY stealth_cua_server.py /app/
COPY start_stealth.sh /

# Make startup script executable
RUN chmod +x /start_stealth.sh

# Expose ports (8005 for stealth server, 5900 for VNC)
EXPOSE 5900 8005

# Set the startup command
CMD ["/start_stealth.sh"]
